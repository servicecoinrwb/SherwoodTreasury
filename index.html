<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sherwood Forest Treasury</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root { --forest-green: #0b2916; --gold: #f1c40f; --accent: #e67e22; --paper: #f4ecd8; }
        body { font-family: 'Courier New', monospace; background: var(--forest-green); color: #ecf0f1; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { background: rgba(0,0,0,0.85); border: 2px solid var(--gold); border-radius: 12px; padding: 25px; width: 100%; max-width: 480px; box-shadow: 0 0 25px rgba(0,0,0,0.7); }
        h1 { color: var(--gold); text-align: center; margin-bottom: 5px; }
        .stat-card { background: #1a1a1a; padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid var(--gold); }
        .stat-label { font-size: 0.75rem; color: var(--gold); text-transform: uppercase; }
        .stat-value { font-size: 1.2rem; font-weight: bold; display: block; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 4px; border: none; background: #222; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; text-transform: uppercase; margin-top: 10px; transition: 0.2s; }
        .btn-gold { background: var(--gold); color: black; }
        .btn-rob { background: transparent; border: 2px solid var(--accent); color: var(--accent); }
        #status { text-align: center; font-size: 0.85rem; margin-top: 15px; color: #2ecc71; font-weight: bold; min-height: 1.2em; }
        .explainer { background: var(--paper); color: #333; padding: 15px; border-radius: 8px; margin-top: 25px; font-size: 0.85rem; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üèπ SHERWOOD FOREST</h1>
        
        <div id="statArea">
            <div class="stat-card"><span class="stat-label">Your Wallet (ETH)</span><span class="stat-value" id="userEth">0.0000</span></div>
            <div class="stat-card"><span class="stat-label">Your Quiver (ARROW)</span><span class="stat-value" id="userArrows">0.00</span></div>
            <div class="stat-card"><span class="stat-label">1 Arrow = </span><span class="stat-value" id="arrowPrice">1.0000 ETH</span></div>
        </div>

        <button id="connectBtn" class="btn-gold">Connect Outlaw Wallet</button>
        <button id="switchNetBtn" class="btn-rob" style="display:none;">Switch to Robinhood Chain</button>
        
        <div id="ui" style="display:none;">
            <input type="number" id="amt" placeholder="Gold (ETH) to Stake" step="0.01">
            <button onclick="doDeposit()" class="btn-gold">Join Merry Men</button>
            <button onclick="doRob()" class="btn-rob">‚öîÔ∏è Rob the Sheriff</button>
            <div id="status">Ready...</div>
        </div>

        <div class="explainer">
            <h3>üìú Scroll of Wisdom</h3>
            <p>1. Deposit ETH to get <b>ARROW</b> tokens.<br>
               2. <b>Rob the Sheriff</b> to pump the price for everyone!<br>
               3. Higher price = more ETH when you eventually withdraw.</p>
        </div>
    </div>

<script>
    const ADDR = "0xd435e6D506424AdA0A3BBc06e6d3E3Bf5E2C157D";
    const ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"villager","type":"address"},{"indexed":false,"internalType":"uint256","name":"ethAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"arrowsMinted","type":"uint256"},{"indexed":false,"internalType":"address","name":"referrer","type":"address"}],"name":"GoldDeposited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"villager","type":"address"},{"indexed":false,"internalType":"uint256","name":"arrowsBurned","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"ethReturned","type":"uint256"}],"name":"GoldWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"by","type":"address"},{"indexed":false,"internalType":"uint256","name":"goldStolen","type":"uint256"}],"name":"SheriffRobbed","type":"event"},{"inputs":[],"name":"REFERRAL_BONUS_BPS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"referrer","type":"address"}],"name":"deposit","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"lastRobbery","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pricePerArrow","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrers","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"robTheSheriff","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalGhostGold","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalTreasuryValue","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"arrowAmount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];

    let contract, signer, provider;

    async function init() {
        if (!window.ethereum) return msg("‚ùå Install MetaMask");
        provider = new ethers.BrowserProvider(window.ethereum);
        
        // Handle account changes
        window.ethereum.on('accountsChanged', () => window.location.reload());
        window.ethereum.on('chainChanged', () => window.location.reload());
    }

    async function connect() {
        try {
            await provider.send("eth_requestAccounts", []);
            const network = await provider.getNetwork();
            
            if (network.chainId !== 46630n) {
                document.getElementById('switchNetBtn').style.display = 'block';
                return msg("‚ùå Wrong Network!");
            }

            signer = await provider.getSigner();
            contract = new ethers.Contract(ADDR, ABI, signer);
            
            document.getElementById('ui').style.display = 'block';
            document.getElementById('connectBtn').style.display = 'none';
            document.getElementById('switchNetBtn').style.display = 'none';
            
            refresh();
            setInterval(refresh, 10000);
        } catch (e) {
            console.error(e);
            msg("‚ùå Connection Failed");
        }
    }

    async function switchNetwork() {
        try {
            await window.ethereum.request({
                method: "wallet_addEthereumChain",
                params: [{
                    chainId: "0xB626", // 46630 in hex
                    chainName: "Robinhood Chain Testnet",
                    rpcUrls: ["https://rpc.testnet.chain.robinhood.com"],
                    nativeCurrency: { name: "ETH", symbol: "ETH", decimals: 18 },
                    blockExplorerUrls: ["https://explorer.testnet.chain.robinhood.com"]
                }]
            });
        } catch (e) { msg("‚ùå Switch Failed"); }
    }

    async function refresh() {
        try {
            const userAddr = await signer.getAddress();
            const walletBal = await provider.getBalance(userAddr);
            const p = await contract.pricePerArrow();
            const q = await contract.balanceOf(userAddr);
            
            document.getElementById('userEth').innerText = ethers.formatEther(walletBal).substring(0,8) + " ETH";
            document.getElementById('arrowPrice').innerText = ethers.formatEther(p).substring(0,6) + " ETH";
            document.getElementById('userArrows').innerText = ethers.formatEther(q).substring(0,6) + " ARROW";
        } catch(e) { console.warn("Syncing..."); }
    }

    async function doDeposit() {
        try {
            const val = document.getElementById('amt').value;
            if(!val || val <= 0) return msg("Enter an amount!");
            const tx = await contract.deposit(ethers.ZeroAddress, { value: ethers.parseEther(val) });
            msg("‚öîÔ∏è Heading to Sherwood...");
            await tx.wait();
            msg("‚úÖ Gold Staked!");
            refresh();
        } catch(e) { msg("‚ùå Deposit Failed"); }
    }

    async function doRob() {
        try {
            const tx = await contract.robTheSheriff();
            msg("üèπ AMBUSHING...");
            await tx.wait();
            msg("‚úÖ Loot Distributed!");
            refresh();
        } catch(e) { msg("‚ùå Sheriff is Alert!"); }
    }

    function msg(m) { document.getElementById('status').innerText = m; }
    
    document.getElementById('connectBtn').onclick = connect;
    document.getElementById('switchNetBtn').onclick = switchNetwork;
    
    init(); // Setup account listeners
</script>
</body>
</html>
